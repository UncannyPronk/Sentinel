import requests
import mimetypes
from urllib.parse import urlparse
from core.security import is_suspicious_domain

DANGEROUS_MIME = [
    "application/x-msdownload",  
    "application/x-msdos-program",
    "application/x-sh",
    "application/x-bat",
    "application/javascript",
    "text/x-python",
    "application/java-archive",
]

DANGEROUS_EXT = [
    ".exe", ".dll", ".bat", ".cmd", ".sh", ".js", ".vbs", ".jar",
    ".apk", ".scr", ".pif", ".msi"
]


def is_malicious_file(url: str):
    """
    Lightweight, offline static malware check.
    Returns:
        (True/False, reason string)
    """

    domain = urlparse(url).netloc
    if is_suspicious_domain(domain):
        return True, f"Domain {domain} looks suspicious."

    lower = url.lower()
    for ext in DANGEROUS_EXT:
        if lower.endswith(ext):
            return True, f"File extension {ext} is potentially unsafe."

    try:
        head = requests.head(url, allow_redirects=True, timeout=5)
        mime = head.headers.get("Content-Type", "").lower()

        if any(d in mime for d in DANGEROUS_MIME):
            return True, f"Unsafe MIME type detected: {mime}"

    except Exception:
        pass 

    try:
        head = requests.head(url, allow_redirects=True, timeout=5)
        size_str = head.headers.get("Content-Length", "0")
        size = int(size_str) if size_str.isdigit() else 0

        if size < 800 and any(url.lower().endswith(e) for e in DANGEROUS_EXT):
            return True, "Suspicious small executable file."
    except:
        pass

    try:
        r = requests.get(url, stream=True, timeout=5)
        first_bytes = r.raw.read(2)
        if first_bytes == b"MZ": 
            return True, "Windows PE executable detected."
    except:
        pass

    return False, "OK"
